events { worker_connections 1024; }

http {
    # ----------------------------------------------------
    # [1] 연결 대상 (Upstream) 정의
    # ----------------------------------------------------

    # 1. GreenPR
    upstream green_web { server ycerp-web-greenpr:8069; }
    upstream green_chat { server ycerp-web-greenpr:8072; }

    # 2. MediPolyTech
    upstream media_web { server ycerp-web-mediapolytech:8069; }
    upstream media_chat { server ycerp-web-mediapolytech:8072; }

    # 3. Visualoft
    upstream visual_web { server ycerp-web-visualoft:8069; }
    upstream visual_chat { server ycerp-web-visualoft:8072; }

    # 4. J&J-i
    upstream jnj_web { server ycerp-web-jnj_i:8069; }
    upstream jnj_chat { server ycerp-web-jnj_i:8072; }

    # 5. FreeWorks
    upstream free_web { server ycerp-web-freeworks:8069; }
    upstream free_chat { server ycerp-web-freeworks:8072; }


    # ----------------------------------------------------
    # [2] 공통 설정
    # ----------------------------------------------------
    proxy_read_timeout 720s;
    proxy_connect_timeout 720s;
    proxy_send_timeout 720s;

    # 헤더 설정 (기본)
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # [중요] 웹소켓 지원을 위한 공통 헤더 설정값
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";


    # ----------------------------------------------------
    # [3] 포트별 라우팅 (Server Block)
    # ----------------------------------------------------

    # 1. GreenPR (30033)
    server {
        listen 30033;
        location / { proxy_pass http://green_web; }
        
        # [핵심] Odoo 16+ 버전은 /websocket 경로를 사용합니다.
        location /websocket {
            proxy_pass http://green_chat;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
        # 구형 브라우저 호환성을 위해 longpolling도 유지
        location /longpolling { proxy_pass http://green_chat; }
    }

    # 2. MediPolyTech (30043)
    server {
        listen 30043;
        location / { proxy_pass http://media_web; }
        
        location /websocket {
            proxy_pass http://media_chat;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
        location /longpolling { proxy_pass http://media_chat; }
    }

    # 3. Visualoft (30053)
    server {
        listen 30053;
        location / { proxy_pass http://visual_web; }

        location /websocket {
            proxy_pass http://visual_chat;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
        location /longpolling { proxy_pass http://visual_chat; }
    }

    # 4. J&J-i (30063)
    server {
        listen 30063;
        location / { proxy_pass http://jnj_web; }

        location /websocket {
            proxy_pass http://jnj_chat;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
        location /longpolling { proxy_pass http://jnj_chat; }
    }

    # 5. FreeWorks (30073)
    server {
        listen 30073;
        location / { proxy_pass http://free_web; }

        location /websocket {
            proxy_pass http://free_chat;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
        location /longpolling { proxy_pass http://free_chat; }
    }
}