<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <record id="account_move_form_inherit_l10n_gt_edi" model="ir.ui.view">
        <field name="name">account.move.form.inherit.l10n_gt_edi</field>
        <field name="model">account.move</field>
        <field name="priority">30</field>
        <field name="inherit_id" ref="account.view_move_form"/>
        <field name="arch" type="xml">
            <xpath expr="//header/button[@name='action_post']" position="after">
                <button name="l10n_gt_edi_send_bill_to_sat"
                        type="object"
                        string="Send to SAT"
                        class="oe_highlight"
                        invisible="not (
                            move_type in ('in_invoice', 'in_refund') and
                            state == 'posted' and
                            l10n_gt_edi_doc_type in ('NABN', 'FESP') and
                            not l10n_gt_edi_state
                        )"/>
            </xpath>

            <xpath expr="//group[@id='header_left_group']" position="inside">
                <field name="l10n_gt_edi_available_doc_types" invisible="1"/> <!--needed for the dynamic_selection widget-->
                <field name="l10n_gt_edi_doc_type"
                       invisible="country_code != 'GT' or not l10n_gt_edi_available_doc_types"
                       required="country_code == 'GT' and l10n_gt_edi_available_doc_types"
                       widget="dynamic_selection"
                       readonly="state != 'draft'"
                       options="{'available_field': 'l10n_gt_edi_available_doc_types'}"/>
            </xpath>

            <xpath expr="//group[@id='header_right_group']" position="inside">
                <field name="l10n_gt_edi_state"
                       invisible="not l10n_gt_edi_state or move_type in ('in_invoice', 'in_refund')"/>
            </xpath>

            <!-- GT Additional Fields in the "Other Info" page -->
            <xpath expr="//page[@id='other_tab']//group[@name='accounting_info_group']" position="inside">
                <field name="l10n_gt_edi_phrase_ids"
                       invisible="country_code != 'GT'"
                       widget="many2many_tags"
                       readonly="state != 'draft'"/>
                <field name="l10n_gt_edi_consignatory_partner"
                       invisible="not l10n_gt_edi_show_consignatory_partner"
                       readonly="state != 'draft'"/>
            </xpath>

            <!-- Guatemalan SAT Documents Tab -->
            <xpath expr="//page[@id='other_tab_entry']" position="after">
                <page id="l10n_gt_edi_documents"
                      string="SAT"
                      invisible="not l10n_gt_edi_document_ids">
                    <field name="l10n_gt_edi_document_ids">
                        <list create="false" delete="false" edit="false" no_open="1"
                              decoration-danger="state == 'invoice_sending_failed'"
                              decoration-success="state == 'invoice_sent'">
                            <field name="message" column_invisible="1"/> <!-- needed for the account_document_state widget -->
                            <field name="datetime"/>
                            <field name="state" widget="account_document_state"/>
                            <field name="uuid"/>
                            <field name="series" optional="hide"/>
                            <field name="serial_number" optional="hide"/>

                            <button name="action_download_file"
                                    type="object"
                                    string="Download Certificate"
                                    invisible="not (attachment_id and state == 'invoice_sent')"/>
                            <button name="action_download_file"
                                    type="object"
                                    string="Download Failed XML"
                                    invisible="not (attachment_id and state == 'invoice_sending_failed')"/>
                        </list>
                    </field>
                </page>
            </xpath>
        </field>
    </record>

    <record id="view_out_invoice_tree_inherit_l10n_gt_edi" model="ir.ui.view">
        <field name="name">account.out.invoice.list.inherit.l10n_gt_edi</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_out_invoice_tree"/>
        <field name="arch" type="xml">
            <field name="status_in_payment" position="before">
                <field name="l10n_gt_edi_state" optional="hide"/>
            </field>
        </field>
    </record>

    <record id="view_out_credit_note_tree_inherit_l10n_gt_edi" model="ir.ui.view">
        <field name="name">account.out.credit.note.list.inherit.l10n_gt_edi</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_out_credit_note_tree"/>
        <field name="arch" type="xml">
            <field name="status_in_payment" position="before">
                <field name="l10n_gt_edi_state" optional="hide"/>
            </field>
        </field>
    </record>

    <record id="view_in_invoice_bill_tree_inherit_l10n_gt_edi" model="ir.ui.view">
        <field name="name">account.in.invoice.list.inherit.l10n_gt_edi</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_in_invoice_tree"/>
        <field name="arch" type="xml">
            <field name="status_in_payment" position="before">
                <field name="l10n_gt_edi_state" optional="hide"/>
            </field>
        </field>
    </record>

    <record id="view_account_invoice_filter_inherit_l10n_gt_edi" model="ir.ui.view">
        <field name="name">account.invoice.select.inherit.l10n_gt_edi</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_account_invoice_filter"/>
        <field name="arch" type="xml">
            <xpath expr="//search/field[@name='journal_id']" position="after">
                <field name="l10n_gt_edi_state"/>
            </xpath>
            <xpath expr="//filter[@name='to_check']" position="after">
                <filter string="Sent to SAT"
                        name="l10n_gt_edi_state_sent"
                        domain="[('l10n_gt_edi_state', '=', 'invoice_sent')]"/>
            </xpath>
            <xpath expr="//group" position="inside">
                <filter string="SAT Status"
                        name="l10n_gt_edi_state_group"
                        domain=""
                        context="{'group_by':'l10n_gt_edi_state'}"/>
            </xpath>
        </field>
    </record>

</odoo>
